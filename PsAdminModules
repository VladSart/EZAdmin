# Check if running PowerShell 7
if ($PSVersionTable.PSVersion.Major -lt 7) {
    Write-Host "Please run this script in PowerShell 7."
    exit
}

# Ensure PowerShellGet is up-to-date
Install-Module -Name PowerShellGet -Force -Scope AllUsers

# Set TLS protocol to ensure secure connections
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Install required modules
$requiredModules = @(
    "PnP.PowerShell",
    "Microsoft.Graph",
    "ExchangeOnlineManagement",
    "AzureAD",
    "MSOnline"
)

foreach ($module in $requiredModules) {
    try {
        if (-not (Get-Module -ListAvailable -Name $module)) {
            Write-Host "Installing module: $module"
            Install-Module -Name $module -Force -Scope AllUsers -AllowClobber -ErrorAction Stop
        } else {
            Write-Host "Module already installed: $module"
        }
        Import-Module -Name $module -ErrorAction Stop
    } catch {
        Write-Host "Failed to install or import module ${module}: $_"
    }
}

# Verify module installation
Write-Host "Verifying module installation..."
Get-Module -ListAvailable | Where-Object { $_.Name -in $requiredModules }

# Continue with your main script functionality here...
